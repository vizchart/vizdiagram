# å›¾ç‰‡ç»„ä»¶åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

DgrmJS æ–°å¢äº†å›¾ç‰‡ç»„ä»¶åŠŸèƒ½ï¼Œæ”¯æŒåœ¨å›¾è¡¨ä¸­æ·»åŠ å›¾ç‰‡å…ƒç´ ï¼Œå¹¶å°†å›¾ç‰‡ä¸Šä¼ åˆ° Drupal AIGC èŠ‚ç‚¹çš„ `ref_images` å­—æ®µä¸­ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¨ ç»„ä»¶ç‰¹æ€§
- **ç±»å‹ID**: 6
- **é»˜è®¤å°ºå¯¸**: 120x120 åƒç´ 
- **è¿æ¥ç‚¹**: ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘
- **å¯è°ƒæ•´å¤§å°**: æ”¯æŒé€šè¿‡æ‹–æ‹½è°ƒæ•´
- **å›¾ç‰‡é€‚é…**: ä¿æŒæ¯”ä¾‹ï¼Œå±…ä¸­è£å‰ªæ˜¾ç¤º

### ğŸ–¼ï¸ è§†è§‰è®¾è®¡
- **å ä½ç¬¦çŠ¶æ€**: è™šçº¿è¾¹æ¡† + å›¾ç‰‡å›¾æ ‡ + "åŒå‡»ä¸Šä¼ å›¾ç‰‡"æç¤º
- **å·²ä¸Šä¼ çŠ¶æ€**: ç»¿è‰²å®çº¿è¾¹æ¡† + æ˜¾ç¤ºå›¾ç‰‡å†…å®¹
- **åŠ è½½çŠ¶æ€**: æ˜¾ç¤º"ä¸Šä¼ ä¸­..."æ–‡å­—

## ä½¿ç”¨æ–¹æ³•

### 1. æ·»åŠ å›¾ç‰‡ç»„ä»¶
1. åœ¨å·¦ä¾§å·¥å…·æ ä¸­æ‰¾åˆ°å›¾ç‰‡ç»„ä»¶æŒ‰é’®ï¼ˆè™šçº¿æ–¹æ¡†å›¾æ ‡ï¼‰
2. æ‹–æ‹½åˆ°ç”»å¸ƒä¸Šçš„ç›®æ ‡ä½ç½®
3. ç»„ä»¶ä¼šæ˜¾ç¤ºä¸ºè™šçº¿è¾¹æ¡†çš„å ä½ç¬¦

### 2. ä¸Šä¼ å›¾ç‰‡
1. åŒå‡»å›¾ç‰‡ç»„ä»¶
2. å¦‚æœå›¾è¡¨å°šæœªä¿å­˜ï¼Œä¼šæç¤ºå…ˆä¿å­˜å›¾è¡¨
3. å¦‚æœå›¾è¡¨å·²ä¿å­˜ï¼Œä¼šå¼¹å‡ºæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
4. é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼‰
5. ç­‰å¾…ä¸Šä¼ å®Œæˆï¼Œå›¾ç‰‡ä¼šæ˜¾ç¤ºåœ¨ç»„ä»¶ä¸­

### 3. è°ƒæ•´å¤§å°
- é€‰ä¸­å›¾ç‰‡ç»„ä»¶åï¼Œå¯ä»¥æ‹–æ‹½è¾¹è§’è°ƒæ•´å¤§å°
- å›¾ç‰‡ä¼šè‡ªåŠ¨é€‚é…æ–°çš„å°ºå¯¸ï¼Œä¿æŒæ¯”ä¾‹

## æŠ€æœ¯å®ç°

### API é›†æˆ
å›¾ç‰‡ä¸Šä¼ ä½¿ç”¨ Drupal JSON:APIï¼Œå…·ä½“æµç¨‹ï¼š

```javascript
// 1. ä¸Šä¼ æ–‡ä»¶åˆ° ref_images å­—æ®µ
POST /jsonapi/node/aigc/ref_images
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="image.jpg"

// 2. è·å–ç°æœ‰ ref_images å€¼
GET /jsonapi/node/aigc/{uuid}?fields[node--aigc]=ref_images

// 3. æ›´æ–°èŠ‚ç‚¹ï¼Œæ·»åŠ æ–°æ–‡ä»¶åˆ°æ•°ç»„
PATCH /jsonapi/node/aigc/{uuid}
{
  "data": {
    "type": "node--aigc",
    "id": "{uuid}",
    "relationships": {
      "ref_images": {
        "data": [...existing_files, {type: "file--file", id: "new_file_id"}]
      }
    }
  }
}
```

### ç»„ä»¶ç»“æ„
```javascript
// å›¾ç‰‡ç»„ä»¶æ•°æ®ç»“æ„
{
  type: 6,                    // ç»„ä»¶ç±»å‹ID
  position: {x: 100, y: 100}, // ä½ç½®
  w: 120,                     // å®½åº¦
  h: 120,                     // é«˜åº¦
  imageUrl: "blob:...",       // å›¾ç‰‡URLï¼ˆæœ¬åœ°é¢„è§ˆï¼‰
  title: "Image",             // æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
  styles: ["cl-green"]        // æ ·å¼ç±»ï¼ˆå¯é€‰ï¼‰
}
```

### SVG æ¨¡æ¿
```xml
<rect data-key="outer" ... />                    <!-- å¤–è¾¹æ¡†ï¼ˆäº‹ä»¶åŒºåŸŸï¼‰ -->
<rect data-key="main" ... stroke-dasharray="5,5" /> <!-- ä¸»è¾¹æ¡†ï¼ˆè™šçº¿ï¼‰ -->
<g data-key="placeholder">                       <!-- å ä½ç¬¦å›¾æ ‡ -->
  <path d="..." fill="#6c757d" opacity="0.3"/>   <!-- å›¾ç‰‡æ¡† -->
  <circle cx="-5" cy="-5" r="3" />               <!-- å¤ªé˜³ -->
  <path d="..." stroke="#6c757d" />              <!-- å±±å³° -->
</g>
<image data-key="image" ... />                   <!-- å®é™…å›¾ç‰‡ -->
<text data-key="text">åŒå‡»ä¸Šä¼ å›¾ç‰‡</text>          <!-- æç¤ºæ–‡å­— -->
```

## çŠ¶æ€ç®¡ç†

### å›¾è¡¨çŠ¶æ€æ£€æŸ¥
```javascript
const currentDiagram = drupalAPI.getCurrentDiagram();
if (!currentDiagram.nodeId) {
  alert('âš ï¸ è¯·å…ˆä¿å­˜å›¾è¡¨ï¼Œç„¶åæ‰èƒ½ä¸Šä¼ å›¾ç‰‡åˆ°ref_imageså­—æ®µ');
  return;
}
```

### ä¸Šä¼ çŠ¶æ€åé¦ˆ
- **å¼€å§‹ä¸Šä¼ **: æ˜¾ç¤º"ä¸Šä¼ ä¸­..."ï¼Œæ–‡å­—å˜è“è‰²
- **ä¸Šä¼ æˆåŠŸ**: æ˜¾ç¤ºå›¾ç‰‡ï¼Œè¾¹æ¡†å˜ç»¿è‰²ï¼Œéšè—å ä½ç¬¦
- **ä¸Šä¼ å¤±è´¥**: æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œæ¢å¤åŸçŠ¶æ€

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯æƒ…å†µ
1. **å›¾è¡¨æœªä¿å­˜**: æç¤ºç”¨æˆ·å…ˆä¿å­˜å›¾è¡¨
2. **ç”¨æˆ·æœªç™»å½•**: æç¤ºè®¤è¯å¤±è´¥
3. **ç½‘ç»œé”™è¯¯**: æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
4. **æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ**: æç¤ºé€‰æ‹©æ­£ç¡®æ ¼å¼
5. **æœåŠ¡å™¨é”™è¯¯**: æ˜¾ç¤ºæœåŠ¡å™¨è¿”å›çš„é”™è¯¯ä¿¡æ¯

### é”™è¯¯å¤„ç†ä»£ç 
```javascript
try {
  const result = await drupalAPI.addImageToRefImagesField(file, nodeUuid);
  if (result.success) {
    // å¤„ç†æˆåŠŸ
  } else {
    throw new Error(result.error || 'Upload failed');
  }
} catch (error) {
  console.error('âŒ Image upload failed:', error);
  alert(`âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:\n\n${error.message}`);
  hideLoading();
}
```

## æµ‹è¯•æ–¹æ³•

### æ‰‹åŠ¨æµ‹è¯•
1. è®¿é—® `test-image-component.html` æµ‹è¯•é¡µé¢
2. ç‚¹å‡»"æ‰“å¼€å›¾è¡¨ç¼–è¾‘å™¨"
3. æ‹–æ‹½å›¾ç‰‡ç»„ä»¶åˆ°ç”»å¸ƒ
4. åŒå‡»ç»„ä»¶æµ‹è¯•ä¸Šä¼ åŠŸèƒ½

### æ§åˆ¶å°æ—¥å¿—
æˆåŠŸä¸Šä¼ æ—¶çš„æ§åˆ¶å°è¾“å‡ºï¼š
```
ğŸ“· Adding image to ref_images field for node: {uuid}
âœ… File uploaded to ref_images field: {file_id}
ğŸ“‹ Current ref_images: [{existing_files}]
âœ… Image successfully added to ref_images field
âœ… Image uploaded successfully to ref_images field
```

## æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶
- `src/shapes/image.js` - å›¾ç‰‡ç»„ä»¶å®ç°
- `doc/IMAGE-COMPONENT.md` - åŠŸèƒ½è¯´æ˜æ–‡æ¡£
- `test-image-component.html` - æµ‹è¯•é¡µé¢

### ä¿®æ”¹æ–‡ä»¶
- `src/shapes/shape-type-map.js` - æ·»åŠ å›¾ç‰‡ç»„ä»¶æ˜ å°„
- `src/ui/shape-menu.js` - æ·»åŠ å›¾ç‰‡ç»„ä»¶æŒ‰é’®
- `src/infrastructure/drupal-api.js` - æ·»åŠ ä¸Šä¼ æ–¹æ³•
- `src/index.js` - è®¾ç½®å…¨å±€ drupalAPI

## æ³¨æ„äº‹é¡¹

1. **ä¾èµ–å…³ç³»**: å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¾èµ– Drupal åç«¯å’Œè®¤è¯çŠ¶æ€
2. **æ–‡ä»¶å¤§å°**: å»ºè®®é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼Œé¿å…å½±å“æ€§èƒ½
3. **å›¾ç‰‡æ ¼å¼**: æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼ˆjpg, png, gif, webpç­‰ï¼‰
4. **æœ¬åœ°é¢„è§ˆ**: ä½¿ç”¨ `URL.createObjectURL()` åˆ›å»ºæœ¬åœ°é¢„è§ˆ
5. **å†…å­˜ç®¡ç†**: é€‚æ—¶è°ƒç”¨ `URL.revokeObjectURL()` é‡Šæ”¾å†…å­˜

## æœªæ¥æ”¹è¿›

1. **æ‹–æ‹½ä¸Šä¼ **: æ”¯æŒç›´æ¥æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶åˆ°ç»„ä»¶
2. **å›¾ç‰‡ç¼–è¾‘**: æ”¯æŒåŸºæœ¬çš„å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼ˆè£å‰ªã€æ—‹è½¬ç­‰ï¼‰
3. **æ‰¹é‡ä¸Šä¼ **: æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šå¼ å›¾ç‰‡
4. **å›¾ç‰‡åº“**: æ˜¾ç¤ºå·²ä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨ï¼Œæ”¯æŒé‡å¤ä½¿ç”¨
5. **å‹ç¼©ä¼˜åŒ–**: è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡ä»¥æé«˜æ€§èƒ½ 