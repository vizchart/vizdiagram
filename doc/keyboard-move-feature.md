# 键盘移动功能

## 功能概述

新增了键盘移动功能，用户可以通过按下方向键（`↑` `↓` `←` `→`）来移动画布中选中的形状组件。移动以网格单位为最小步长，确保形状对齐到网格。

## 使用方法

### 移动单个形状
1. 点击画布中的任意形状组件进行选择
2. 选中的形状会显示选择状态（蓝色边框或高亮显示）
3. 按下方向键（`↑` `↓` `←` `→`）
4. 选中的形状将按网格单位移动

### 移动多个形状
1. 使用鼠标拖拽选择多个形状，或者按住 `Ctrl` 键点击多个形状
2. 选中的形状会显示高亮状态
3. 按下方向键（`↑` `↓` `←` `→`）
4. 所有选中的形状将同时移动

### 移动连接线
1. 点击画布中的连接线进行选择
2. 选中的连接线会显示选择状态
3. 按下方向键（`↑` `↓` `←` `→`）
4. 连接线的自由端点将移动（连接到形状的端点不会移动）

## 移动特性

### 网格对齐
- 每次按键移动的距离为一个网格单位（默认24像素）
- 确保形状始终对齐到网格，保持图表的整洁性
- 移动距离与画布的网格设置保持一致

### 精确控制
- 支持连续按键进行连续移动
- 每次移动都是精确的网格单位，便于精细调整位置
- 比鼠标拖拽更适合进行微调

## 安全特性

### 输入保护
- 当用户正在输入框、文本区域或可编辑元素中输入时，键盘移动功能会被禁用
- 这确保了用户在编辑文本时不会意外移动形状

### 焦点检查
- 只有当画布或其子元素获得焦点时，键盘移动功能才会生效
- 这避免了在其他界面元素获得焦点时误移动形状

### 历史记录
- 移动操作会自动保存到历史记录中
- 用户可以通过 `Ctrl+Z` 撤销移动操作

## 技术实现

### 核心模块
- **文件位置**: `src/infrastructure/keyboard-move.js`
- **主要函数**: `keyboardMoveApply(canvas)`

### 集成方式
在主入口文件 `src/index.js` 中初始化：
```javascript
import { keyboardMoveApply } from './infrastructure/keyboard-move.js';

// 在画布初始化后调用
keyboardMoveApply(canvas);
```

### 事件处理
- 监听全局 `keydown` 事件
- 检查按键是否为方向键（`ArrowUp`, `ArrowDown`, `ArrowLeft`, `ArrowRight`）
- 验证当前焦点和输入状态
- 查找选中的形状并执行移动

### 移动计算
- 根据方向键计算移动增量（deltaX, deltaY）
- 移动距离为网格单位（canvas.data.cell，默认24像素）
- 更新形状位置数据并重绘

### 形状识别
通过检查画布子元素的CSS类来识别选中的形状：
- `select` 类：单个选中的形状
- `highlight` 类：多选或编辑状态的形状

## 支持的形状类型

- ✅ 矩形 (Rectangle)
- ✅ 圆形 (Circle) 
- ✅ 菱形 (Rhomb)
- ✅ 文本框 (Text)
- ✅ 容器 (Container)
- ✅ 图片 (Image)
- ✅ 连接线 (Path) - 仅移动未连接到形状的端点

## 连接线特殊处理

对于连接线（Path），移动行为有特殊逻辑：
- **连接到形状的端点**：不会移动，保持与形状的连接
- **自由端点**：会随方向键移动
- **完全自由的连接线**：两个端点都会移动

## 注意事项

1. **网格对齐**: 所有移动都以网格单位为准，确保图表整洁
2. **批量移动**: 支持同时移动多个选中的形状
3. **连接线处理**: 智能处理连接线的端点移动
4. **性能优化**: 移动操作会触发历史记录保存，连续移动时会有轻微延迟
5. **组合操作**: 可以与其他键盘快捷键组合使用

## 快捷键总结

| 快捷键 | 功能 |
|--------|------|
| `↑` (ArrowUp) | 向上移动一个网格单位 |
| `↓` (ArrowDown) | 向下移动一个网格单位 |
| `←` (ArrowLeft) | 向左移动一个网格单位 |
| `→` (ArrowRight) | 向右移动一个网格单位 |
| `Ctrl+Z` | 撤销移动操作 |
| `Ctrl+Y` | 重做移动操作 |

## 与其他功能的配合

### 与键盘删除功能配合
- 可以先用方向键调整位置，再用 `Delete` 键删除
- 两个功能使用相同的形状选择逻辑

### 与鼠标操作配合
- 可以用鼠标选择形状，然后用键盘移动
- 键盘移动比鼠标拖拽更适合精确定位

### 与网格系统配合
- 移动距离与网格大小完全一致
- 有助于保持图表的规整性和专业外观 