# Ref Images æ¸…ç†åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

å½“ä¿å­˜å›¾è¡¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç† `ref_images` å­—æ®µä¸­ä¸å†ä½¿ç”¨çš„å›¾ç‰‡æ–‡ä»¶ï¼Œé¿å…å†—ä½™æ–‡ä»¶ç§¯ç´¯ã€‚

## å·¥ä½œåŸç†

### 1. å›¾ç‰‡ç»„ä»¶æ•°æ®ç»“æ„

å›¾ç‰‡ç»„ä»¶æ ¹æ®å›¾ç‰‡å¤§å°é‡‡ç”¨ä¸åŒçš„å­˜å‚¨æ–¹å¼ï¼š

#### å¤§å›¾ç‰‡ï¼ˆâ‰¥100KBï¼‰
å­˜å‚¨ä¸¤ä¸ªå…³é”®å­—æ®µï¼š
- `imageUrl`: å›¾ç‰‡çš„URLåœ°å€
- `fileId`: å›¾ç‰‡æ–‡ä»¶åœ¨Drupalä¸­çš„æ–‡ä»¶ID

```javascript
// å¤§å›¾ç‰‡ç»„ä»¶æ•°æ®ç¤ºä¾‹
{
  type: 6,
  position: { x: 100, y: 100 },
  w: 120,
  h: 120,
  imageUrl: "/sites/graphmaker/files/aigc_ref_images/2025-06/image.png",
  fileId: "12345-abcd-6789-efgh"
}
```

#### å°å›¾ç‰‡ï¼ˆ<100KBï¼‰
ä»…å­˜å‚¨base64æ•°æ®ï¼š
- `imageUrl`: base64æ ¼å¼çš„å›¾ç‰‡æ•°æ®
- `fileId`: ä¸è®¾ç½®ï¼ˆundefinedæˆ–nullï¼‰

```javascript
// å°å›¾ç‰‡ç»„ä»¶æ•°æ®ç¤ºä¾‹
{
  type: 6,
  position: { x: 100, y: 100 },
  w: 120,
  h: 120,
  imageUrl: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  fileId: undefined
}
```

### 2. ä¸Šä¼ æµç¨‹

å½“ç”¨æˆ·åŒå‡»å›¾ç‰‡ç»„ä»¶ä¸Šä¼ å›¾ç‰‡æ—¶ï¼š

1. **æ£€æŸ¥å›¾ç‰‡å¤§å°**ï¼š
   - å¦‚æœå›¾ç‰‡å°äº100KBï¼Œç›´æ¥è½¬æ¢ä¸ºbase64æ ¼å¼åµŒå…¥åˆ°ç»„ä»¶ä¸­ï¼Œæ— éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨
   - å¦‚æœå›¾ç‰‡å¤§äºç­‰äº100KBï¼Œæ‰§è¡Œåç»­ä¸Šä¼ æµç¨‹

2. **å¤§å›¾ç‰‡ä¸Šä¼ æµç¨‹**ï¼ˆä»…é€‚ç”¨äºâ‰¥100KBçš„å›¾ç‰‡ï¼‰ï¼š
   - æ£€æŸ¥å›¾è¡¨æ˜¯å¦å·²ä¿å­˜ï¼ˆæœ‰nodeIdï¼‰
   - ä¸Šä¼ å›¾ç‰‡åˆ° `/jsonapi/node/aigc/ref_images` ç«¯ç‚¹
   - è·å–è¿”å›çš„æ–‡ä»¶IDå’ŒURL
   - åŒæ—¶ä¿å­˜ `imageUrl` å’Œ `fileId` åˆ°ç»„ä»¶æ•°æ®ä¸­

3. **å°å›¾ç‰‡å¤„ç†æµç¨‹**ï¼ˆé€‚ç”¨äº<100KBçš„å›¾ç‰‡ï¼‰ï¼š
   - å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64æ ¼å¼
   - ç›´æ¥ä¿å­˜base64æ•°æ®åˆ° `imageUrl` å­—æ®µ
   - ä¸è®¾ç½® `fileId`ï¼ˆå› ä¸ºæ²¡æœ‰ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰

### 3. æ¸…ç†æµç¨‹

å½“ä¿å­˜å›¾è¡¨æ—¶ï¼ˆä»…å¯¹æ›´æ–°æ“ä½œï¼Œä¸åŒ…æ‹¬æ–°å»ºï¼‰ï¼š

1. **æ‰«æå›¾è¡¨æ•°æ®**ï¼šéå†æ‰€æœ‰å›¾ç‰‡ç»„ä»¶ï¼ˆtype: 6ï¼‰ï¼Œæ”¶é›†ä½¿ç”¨ä¸­çš„æ–‡ä»¶ID
   - åªæ”¶é›†æœ‰ `fileId` çš„ç»„ä»¶ï¼ˆå³å¤§å›¾ç‰‡ç»„ä»¶ï¼‰
   - å¿½ç•¥base64æ ¼å¼çš„å°å›¾ç‰‡ç»„ä»¶ï¼ˆå› ä¸ºå®ƒä»¬æ²¡æœ‰fileIdï¼Œä¸å ç”¨æœåŠ¡å™¨å­˜å‚¨ï¼‰
2. **è·å–å½“å‰ref_images**ï¼šä»èŠ‚ç‚¹è·å–å½“å‰ `ref_images` å­—æ®µçš„æ‰€æœ‰æ–‡ä»¶ID
3. **è¯†åˆ«æœªä½¿ç”¨æ–‡ä»¶**ï¼šå¯¹æ¯”ä¸¤ä¸ªåˆ—è¡¨ï¼Œæ‰¾å‡ºä¸å†ä½¿ç”¨çš„æ–‡ä»¶ID
4. **æ›´æ–°ref_imageså­—æ®µ**ï¼šç§»é™¤æœªä½¿ç”¨çš„æ–‡ä»¶å¼•ç”¨ï¼Œä¿ç•™ä»åœ¨ä½¿ç”¨çš„æ–‡ä»¶

## ä»£ç å®ç°

### ä¸»è¦æ–¹æ³•

#### `cleanupUnusedRefImages(nodeUuid, diagramData)`

```javascript
async cleanupUnusedRefImages(nodeUuid, diagramData) {
  // 1. ä»å›¾è¡¨æ•°æ®ä¸­æå–ä½¿ç”¨ä¸­çš„æ–‡ä»¶ID
  const usedFileIds = new Set();
  for (const shape of diagramData.s) {
    if (shape.type === 6 && shape.fileId) {
      usedFileIds.add(shape.fileId);
    }
  }
  
  // 2. è·å–å½“å‰ref_imageså­—æ®µ
  const currentRefImages = await getCurrentRefImages(nodeUuid);
  
  // 3. æ‰¾å‡ºæœªä½¿ç”¨çš„æ–‡ä»¶
  const unusedFileIds = currentRefImages.filter(
    refImage => !usedFileIds.has(refImage.id)
  );
  
  // 4. æ›´æ–°ref_imageså­—æ®µï¼Œç§»é™¤æœªä½¿ç”¨çš„æ–‡ä»¶
  if (unusedFileIds.length > 0) {
    await updateRefImagesField(nodeUuid, usedFileIds);
  }
}
```

### é›†æˆåˆ°ä¿å­˜æµç¨‹

åœ¨ `saveDiagramToCloud` æ–¹æ³•ä¸­ï¼Œæ¸…ç†æ­¥éª¤åœ¨èŠ‚ç‚¹æ›´æ–°å®Œæˆåæ‰§è¡Œï¼š

```javascript
// 6. æ¸…ç†æœªä½¿ç”¨çš„ref_imagesï¼ˆä»…å¯¹æ›´æ–°çš„èŠ‚ç‚¹æ‰§è¡Œï¼‰
if (!isNewNode && diagramData && this.currentDiagram.nodeId) {
  try {
    console.log('ğŸ§¹ Cleaning up unused ref_images...');
    await this.cleanupUnusedRefImages(this.currentDiagram.nodeId, diagramData);
  } catch (cleanupError) {
    console.warn('âš ï¸ Failed to cleanup unused ref_images:', cleanupError);
    // ä¸è®©æ¸…ç†å¤±è´¥å½±å“æ•´ä¸ªä¿å­˜æµç¨‹
  }
}
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ›¿æ¢å¤§å›¾ç‰‡
1. ç”¨æˆ·ä¸Šä¼ å¤§å›¾ç‰‡Aï¼ˆâ‰¥100KBï¼‰åˆ°å›¾ç‰‡ç»„ä»¶
2. ä¿å­˜å›¾è¡¨ï¼ˆå›¾ç‰‡Aæ·»åŠ åˆ°ref_imagesï¼‰
3. ç”¨æˆ·åŒå‡»åŒä¸€ç»„ä»¶ï¼Œä¸Šä¼ å¤§å›¾ç‰‡Bæ›¿æ¢å›¾ç‰‡A
4. ä¿å­˜å›¾è¡¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ä»ref_imagesä¸­ç§»é™¤å›¾ç‰‡Aï¼Œä¿ç•™å›¾ç‰‡B

### åœºæ™¯2ï¼šå¤§å›¾ç‰‡æ›¿æ¢ä¸ºå°å›¾ç‰‡
1. ç”¨æˆ·ä¸Šä¼ å¤§å›¾ç‰‡ï¼ˆâ‰¥100KBï¼‰åˆ°å›¾ç‰‡ç»„ä»¶
2. ä¿å­˜å›¾è¡¨ï¼ˆå›¾ç‰‡æ·»åŠ åˆ°ref_imagesï¼‰
3. ç”¨æˆ·åŒå‡»åŒä¸€ç»„ä»¶ï¼Œä¸Šä¼ å°å›¾ç‰‡ï¼ˆ<100KBï¼‰æ›¿æ¢å¤§å›¾ç‰‡
4. ä¿å­˜å›¾è¡¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ä»ref_imagesä¸­ç§»é™¤åŸå¤§å›¾ç‰‡ï¼Œæ–°çš„å°å›¾ç‰‡ä»¥base64æ ¼å¼å­˜å‚¨

### åœºæ™¯3ï¼šå°å›¾ç‰‡æ›¿æ¢ä¸ºå¤§å›¾ç‰‡
1. ç”¨æˆ·ä¸Šä¼ å°å›¾ç‰‡ï¼ˆ<100KBï¼‰åˆ°å›¾ç‰‡ç»„ä»¶ï¼ˆä»¥base64å­˜å‚¨ï¼‰
2. ä¿å­˜å›¾è¡¨ï¼ˆæ— æ–‡ä»¶æ·»åŠ åˆ°ref_imagesï¼‰
3. ç”¨æˆ·åŒå‡»åŒä¸€ç»„ä»¶ï¼Œä¸Šä¼ å¤§å›¾ç‰‡ï¼ˆâ‰¥100KBï¼‰æ›¿æ¢å°å›¾ç‰‡
4. ä¿å­˜å›¾è¡¨æ—¶ï¼Œå¤§å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶æ·»åŠ åˆ°ref_images

### åœºæ™¯4ï¼šåˆ é™¤å›¾ç‰‡ç»„ä»¶
1. ç”¨æˆ·ä¸Šä¼ å¤§å›¾ç‰‡åˆ°å›¾ç‰‡ç»„ä»¶
2. ä¿å­˜å›¾è¡¨
3. ç”¨æˆ·åˆ é™¤è¯¥å›¾ç‰‡ç»„ä»¶
4. ä¿å­˜å›¾è¡¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ä»ref_imagesä¸­ç§»é™¤è¯¥å›¾ç‰‡æ–‡ä»¶

### åœºæ™¯5ï¼šå¤åˆ¶ç²˜è´´å›¾ç‰‡ç»„ä»¶
1. ç”¨æˆ·ä¸Šä¼ å¤§å›¾ç‰‡åˆ°å›¾ç‰‡ç»„ä»¶A
2. å¤åˆ¶ç»„ä»¶Aï¼Œç²˜è´´ä¸ºç»„ä»¶Bï¼ˆå…±äº«åŒä¸€ä¸ªfileIdï¼‰
3. åˆ é™¤ç»„ä»¶Aï¼Œä¿ç•™ç»„ä»¶B
4. ä¿å­˜æ—¶ï¼Œç”±äºç»„ä»¶Bä»åœ¨ä½¿ç”¨è¯¥æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸ä¼šè¢«æ¸…ç†

### åœºæ™¯6ï¼šå°å›¾ç‰‡ç»„ä»¶æ“ä½œ
1. ç”¨æˆ·ä¸Šä¼ å°å›¾ç‰‡ï¼ˆ<100KBï¼‰åˆ°å¤šä¸ªå›¾ç‰‡ç»„ä»¶
2. å¤åˆ¶ã€åˆ é™¤ã€ä¿®æ”¹è¿™äº›ç»„ä»¶
3. ä¿å­˜å›¾è¡¨æ—¶ï¼Œç”±äºå°å›¾ç‰‡éƒ½æ˜¯base64æ ¼å¼ï¼Œä¸æ¶‰åŠref_imagesæ¸…ç†

## å®‰å…¨ç‰¹æ€§

1. **ä¿å®ˆç­–ç•¥**ï¼šå¦‚æœæ— æ³•ç¡®å®šæ–‡ä»¶æ˜¯å¦åœ¨ä½¿ç”¨ï¼Œç³»ç»Ÿä¼šä¿ç•™æ–‡ä»¶è€Œä¸æ˜¯åˆ é™¤
2. **é”™è¯¯éš”ç¦»**ï¼šæ¸…ç†å¤±è´¥ä¸ä¼šå½±å“å›¾è¡¨ä¿å­˜çš„ä¸»è¦æµç¨‹
3. **ä»…æ›´æ–°æ“ä½œ**ï¼šåªå¯¹ç°æœ‰å›¾è¡¨çš„æ›´æ–°æ“ä½œæ‰§è¡Œæ¸…ç†ï¼Œæ–°å»ºå›¾è¡¨ä¸æ‰§è¡Œæ¸…ç†
4. **è¯¦ç»†æ—¥å¿—**ï¼šæä¾›è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§

## æ—¥å¿—ç¤ºä¾‹

```
ğŸ§¹ Cleaning up unused ref_images...
ğŸ” Analyzing diagram for used images...
ğŸ“· Found used image URL: /sites/graphmaker/files/aigc_ref_images/2025-06/image1.png
ğŸ”— Found used file ID: 12345-abcd-6789-efgh (URL: /sites/graphmaker/files/aigc_ref_images/2025-06/image1.png)
ğŸ“Š Total used images: 1
ğŸ“‹ Current ref_images count: 3
ğŸ—‘ï¸ Found unused file ID: 98765-wxyz-4321-ijkl
ğŸ—‘ï¸ Found unused file ID: 11111-aaaa-2222-bbbb
ğŸ§¹ Removing 2 unused files from ref_images...
âœ… Successfully cleaned up 2 unused files from ref_images
ğŸ“Š Remaining ref_images count: 1
```

## æ³¨æ„äº‹é¡¹

1. **å›¾ç‰‡å¤§å°é˜ˆå€¼**ï¼š100KBæ˜¯åŒºåˆ†å¤§å°å›¾ç‰‡çš„å…³é”®é˜ˆå€¼ï¼Œå°äº100KBçš„å›¾ç‰‡ä½¿ç”¨base64å­˜å‚¨ï¼Œä¸å ç”¨æœåŠ¡å™¨æ–‡ä»¶å­˜å‚¨ç©ºé—´
2. **æ–‡ä»¶IDä¾èµ–**ï¼šæ¸…ç†åŠŸèƒ½ä¾èµ–äºå¤§å›¾ç‰‡ç»„ä»¶æ­£ç¡®å­˜å‚¨fileIdï¼Œå°å›¾ç‰‡ç»„ä»¶å’Œæ—§çš„å›¾ç‰‡ç»„ä»¶å¯èƒ½æ²¡æœ‰fileId
3. **å­˜å‚¨ä¼˜åŒ–**ï¼šå°å›¾ç‰‡ä½¿ç”¨base64æ ¼å¼å¯ä»¥å‡å°‘HTTPè¯·æ±‚ï¼Œä½†ä¼šå¢åŠ å›¾è¡¨æ•°æ®å¤§å°ï¼›å¤§å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨å¯ä»¥å‡å°‘å›¾è¡¨æ•°æ®å¤§å°ï¼Œä½†éœ€è¦é¢å¤–çš„HTTPè¯·æ±‚
4. **ç½‘ç»œé”™è¯¯å¤„ç†**ï¼šå¦‚æœæ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œä¸ä¼šå½±å“å›¾è¡¨ä¿å­˜
5. **æ€§èƒ½å½±å“**ï¼šæ¸…ç†æ“ä½œä¼šå¢åŠ ä¿å­˜æ—¶é—´ï¼Œä½†é€šå¸¸å¾ˆå¿«å®Œæˆ
6. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å›¾è¡¨æ•°æ®å’Œref_imageså­—æ®µä¿æŒä¸€è‡´ï¼Œbase64æ ¼å¼çš„å°å›¾ç‰‡ä¸ä¼šå½±å“ref_imageså­—æ®µ 