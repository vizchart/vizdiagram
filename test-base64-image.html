<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 Image Upload Test - DgrmJS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .feature-list {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        
        .feature-list ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .feature-list li {
            margin-bottom: 8px;
        }
        
        .code-block {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            border-left: 4px solid #4caf50;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .steps {
            counter-reset: step-counter;
        }
        
        .step {
            counter-increment: step-counter;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        
        .step::before {
            content: "æ­¥éª¤ " counter(step-counter) ": ";
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ–¼ï¸ Base64 å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
        <p>DgrmJS æ–°å¢åŠŸèƒ½ï¼šå°äº200KBçš„å›¾ç‰‡è‡ªåŠ¨ä½¿ç”¨base64åµŒå…¥åˆ°JSONä¸­</p>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ åŠŸèƒ½æ¦‚è¿°</h2>
        <div class="feature-list">
            <h3>æ–°å¢åŠŸèƒ½ç‰¹æ€§ï¼š</h3>
            <ul>
                <li><strong>æ™ºèƒ½æ–‡ä»¶å¤§å°æ£€æµ‹</strong>ï¼šè‡ªåŠ¨æ£€æµ‹ä¸Šä¼ å›¾ç‰‡çš„æ–‡ä»¶å¤§å°</li>
                <li><strong>Base64åµŒå…¥</strong>ï¼šå°äº200KBçš„å›¾ç‰‡è½¬æ¢ä¸ºbase64å¹¶ç›´æ¥åµŒå…¥åˆ°å›¾è¡¨JSONä¸­</li>
                <li><strong>æœåŠ¡å™¨ä¸Šä¼ </strong>ï¼šå¤§äºç­‰äº200KBçš„å›¾ç‰‡ç»§ç»­ä½¿ç”¨åŸæœ‰çš„æœåŠ¡å™¨ä¸Šä¼ æµç¨‹</li>
                <li><strong>æ— éœ€ç™»å½•</strong>ï¼šBase64å›¾ç‰‡ä¸éœ€è¦ç™»å½•æˆ–ä¿å­˜å›¾è¡¨å³å¯ä½¿ç”¨</li>
                <li><strong>ç¦»çº¿å‹å¥½</strong>ï¼šBase64å›¾ç‰‡å®Œå…¨è‡ªåŒ…å«ï¼Œæ”¯æŒç¦»çº¿ä½¿ç”¨</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ æŠ€æœ¯å®ç°</h2>
        
        <h3>æ–‡ä»¶å¤§å°æ£€æµ‹é€»è¾‘ï¼š</h3>
        <div class="code-block">
const fileSizeKB = file.size / 1024;
console.log(`File size: ${fileSizeKB.toFixed(2)} KB`);

// æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¦‚æœå°äº100KBåˆ™ä½¿ç”¨base64åµŒå…¥åˆ°JSONä¸­
if (file.size < 100 * 1024) { // 100KB = 100 * 1024 bytes
    // è½¬æ¢ä¸ºbase64 data URL
    const base64Url = await fileToBase64(file);
    
    // ç›´æ¥åœ¨æœ¬åœ°æ˜¾ç¤ºå›¾ç‰‡ï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨
    // base64æ•°æ®å°†è‡ªåŠ¨åµŒå…¥åˆ°å›¾è¡¨JSONä¸­ï¼Œæ— éœ€æœåŠ¡å™¨å­˜å‚¨
    imageData.imageUrl = base64Url;
    imageData.fileId = null;
    imageData.isBase64 = true;
} else {
    // å¤§æ–‡ä»¶ç»§ç»­ä½¿ç”¨æœåŠ¡å™¨ä¸Šä¼ æµç¨‹
    const result = await drupalAPI.addImageToRefImagesField(file, nodeId);
}
        </div>

        <h3>Base64è½¬æ¢å‡½æ•°ï¼š</h3>
        <div class="code-block">
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h2>
        <div class="steps">
            <div class="step">
                æ‰“å¼€DgrmJSå›¾è¡¨ç¼–è¾‘å™¨
            </div>
            <div class="step">
                ä»å·¦ä¾§å·¥å…·æ æ‹–æ‹½å›¾ç‰‡ç»„ä»¶åˆ°ç”»å¸ƒä¸Š
            </div>
            <div class="step">
                åŒå‡»å›¾ç‰‡ç»„ä»¶ï¼Œé€‰æ‹©å›¾ç‰‡æ–‡ä»¶
                <div class="highlight">
                    <strong>æµ‹è¯•å»ºè®®ï¼š</strong>å‡†å¤‡ä¸¤ä¸ªå›¾ç‰‡æ–‡ä»¶
                    <ul>
                        <li><strong>å°å›¾ç‰‡</strong>ï¼š< 100KBï¼ˆå¦‚å°å›¾æ ‡ã€ç®€å•å›¾å½¢ï¼‰- å¯ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ç™»å½•æˆ–ä¿å­˜</li>
                        <li><strong>å¤§å›¾ç‰‡</strong>ï¼š> 100KBï¼ˆå¦‚é«˜åˆ†è¾¨ç‡ç…§ç‰‡ï¼‰- éœ€è¦ç™»å½•å¹¶ä¿å­˜ç”»å¸ƒ</li>
                    </ul>
                </div>
            </div>
            <div class="step">
                è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œåº”è¯¥çœ‹åˆ°ï¼š
                <div class="code-block">
ğŸ“¦ File is less than 100KB, using base64 embedding...
âœ… Image embedded as base64 successfully
                </div>
            </div>
            <div class="step">
                å¯¼å‡ºå›¾è¡¨JSONï¼ˆèœå• â†’ Export Metadataï¼‰ï¼Œæ£€æŸ¥JSONæ–‡ä»¶ä¸­çš„å›¾ç‰‡æ•°æ®ï¼š
                <div class="code-block">
{
  "type": 6,
  "position": {"x": 100, "y": 100},
  "w": 120,
  "h": 120,
  "imageUrl": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "fileId": null,
  "isBase64": true
}
                </div>
            </div>
            <div class="step">
                æµ‹è¯•å¤§æ–‡ä»¶ï¼ˆ>200KBï¼‰ï¼Œåº”è¯¥çœ‹åˆ°æ™ºèƒ½æç¤ºï¼š
                <div class="code-block">
ğŸ” å›¾ç‰‡å¤§äº200KBéœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨

è¯·å…ˆç™»å½•ï¼Œç„¶åå›åˆ°è¿™é‡Œä¿å­˜å›¾ç‰‡ï¼š
https://graphmaker.intra.vizcms.cn/user/login

ğŸ’¡ æç¤ºï¼šå¦‚æœä½¿ç”¨å°äº200KBçš„å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥åµŒå…¥æ— éœ€ç™»å½•
                </div>
                å¦‚æœå·²ç™»å½•ä½†æœªä¿å­˜ç”»å¸ƒï¼Œä¼šçœ‹åˆ°ï¼š
                <div class="code-block">
âš ï¸ å›¾ç‰‡å¤§äº200KBéœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨

è¯·å…ˆä¿å­˜æ‚¨çš„ç”»å¸ƒï¼Œç„¶åæ‰èƒ½ä¸Šä¼ å¤§å›¾ç‰‡

ğŸ’¡ æç¤ºï¼šå¦‚æœä½¿ç”¨å°äº200KBçš„å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥åµŒå…¥æ— éœ€ä¿å­˜ç”»å¸ƒ
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>âœ… é¢„æœŸç»“æœ</h2>
        
        <h3><span class="success">å°æ–‡ä»¶ï¼ˆ< 200KBï¼‰ï¼š</span></h3>
        <ul>
            <li>âœ… æ— éœ€ç™»å½•å³å¯ä½¿ç”¨</li>
            <li>âœ… æ— éœ€ä¿å­˜å›¾è¡¨å³å¯æ·»åŠ å›¾ç‰‡</li>
            <li>âœ… å›¾ç‰‡æ•°æ®ç›´æ¥åµŒå…¥JSON</li>
            <li>âœ… æ§åˆ¶å°æ˜¾ç¤ºbase64åµŒå…¥æˆåŠŸ</li>
            <li>âœ… imageData.isBase64 = true</li>
            <li>âœ… imageData.fileId = null</li>
        </ul>

        <h3><span class="info">å¤§æ–‡ä»¶ï¼ˆâ‰¥ 200KBï¼‰ï¼š</span></h3>
        <ul>
            <li>ğŸ” éœ€è¦ç™»å½•æ‰èƒ½ä¸Šä¼ </li>
            <li>ğŸ’¾ éœ€è¦å…ˆä¿å­˜å›¾è¡¨</li>
            <li>â˜ï¸ ä¸Šä¼ åˆ°æœåŠ¡å™¨ref_imageså­—æ®µ</li>
            <li>ğŸ”— imageData.fileIdåŒ…å«æœåŠ¡å™¨æ–‡ä»¶ID</li>
            <li>âœ… imageData.isBase64 = false</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ‰ ä¼˜åŠ¿æ€»ç»“</h2>
        <div class="feature-list">
            <h3>è¿™ä¸ªåŠŸèƒ½å¸¦æ¥çš„å¥½å¤„ï¼š</h3>
            <ul>
                <li><strong>æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ</strong>ï¼šå°å›¾ç‰‡å¯ä»¥ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€ç™»å½•</li>
                <li><strong>å‡å°‘æœåŠ¡å™¨è´Ÿè½½</strong>ï¼šå°æ–‡ä»¶ä¸å ç”¨æœåŠ¡å™¨å­˜å‚¨ç©ºé—´</li>
                <li><strong>å®Œå…¨è‡ªåŒ…å«</strong>ï¼šå›¾è¡¨JSONåŒ…å«æ‰€æœ‰å¿…è¦æ•°æ®ï¼Œä¾¿äºåˆ†äº«</li>
                <li><strong>ç¦»çº¿æ”¯æŒ</strong>ï¼šBase64å›¾ç‰‡æ”¯æŒå®Œå…¨ç¦»çº¿ä½¿ç”¨</li>
                <li><strong>æ™ºèƒ½é€‰æ‹©</strong>ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¤„ç†æ–¹å¼</li>
                <li><strong>å‘åå…¼å®¹</strong>ï¼šä¸å½±å“ç°æœ‰çš„å¤§æ–‡ä»¶ä¸Šä¼ æµç¨‹</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ” æŠ€æœ¯ç»†èŠ‚</h2>
        
        <h3>æ•°æ®ç»“æ„æ›´æ–°ï¼š</h3>
        <div class="code-block">
// ImageDataç±»å‹å®šä¹‰å·²æ›´æ–°
typedef {{
    type: number,
    position: Point,
    title?: string,
    styles?: string[],
    w?: number,
    h?: number,
    imageUrl?: string,
    fileId?: string,
    isBase64?: boolean  // æ–°å¢ï¼šæ ‡è¯†æ˜¯å¦ä¸ºbase64å›¾ç‰‡
}} ImageData
        </div>

        <h3>æ–‡ä»¶å¤§å°é˜ˆå€¼ï¼š</h3>
        <div class="highlight">
            <strong>100KBé˜ˆå€¼é€‰æ‹©ç†ç”±ï¼š</strong>
            <ul>
                <li>è¶³å¤Ÿå®¹çº³å¤§å¤šæ•°å›¾æ ‡ã€ç®€å•å›¾å½¢å’Œå°å›¾ç‰‡</li>
                <li>é¿å…JSONæ–‡ä»¶è¿‡å¤§å½±å“æ€§èƒ½</li>
                <li>å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½</li>
            </ul>
        </div>
    </div>
</body>
</html> 