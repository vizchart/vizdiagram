name: Sync to Public Repository

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          # Fetches all history for all branches and tags.
          fetch-depth: 0

      - name: Remove private files
        run: |
          # Use 'git rm' to remove files/folders. This command removes them
          # from the filesystem AND stages the deletion for the commit in one step.
          # The --ignore-unmatch flag prevents errors if the files don't exist.
          git rm -rf --ignore-unmatch doc/ .env .github/workflows/sync-to-vizchart.yml

      - name: Push to public repo using SSH
        env:
          # This secret must be the PRIVATE part of the SSH key you created.
          # It must be stored in the private repository's secrets.
          SSH_PRIVATE_KEY: ${{ secrets.SYNC_SSH_PRIVATE_KEY }}
        run: |
          # Verify the secret is loaded before proceeding.
          if [ -z "${SSH_PRIVATE_KEY}" ]; then
            echo "âŒ ERROR: The SYNC_SSH_PRIVATE_KEY secret is not set."
            echo "Please add it to the private repository's secrets."
            exit 1
          fi

          # Set up the SSH environment for authentication.
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Configure git with a generic user identity.
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # Commit the changes (e.g., the removal of private files).
          # The '|| true' part prevents the workflow from failing if there are no changes to commit.
          git add .
          git commit -m "chore: remove private files for public sync" || true

          # Add the public repository as a remote using the SSH URL.
          git remote add public git@github.com:vizchart/vizdiagram.git
          
          # Force-push the current state to the public repository's main branch.
          git push -f public HEAD:main
          # Push tags to public repository and then it will trigger the release workflow to build the release package
          git push public --tags

